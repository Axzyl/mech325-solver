<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helical Gear Spec Calculator</title>

    <!-- MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #pdf-panel {
            flex: 1;
            background: #fff;
            border-right: 2px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        #pdf-panel iframe {
            flex: 1;
            border: none;
            width: 100%;
        }

        #calculator-panel {
            flex: 1;
            background: #fff;
            overflow-y: auto;
            padding: 20px 40px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
        }

        .section h3 {
            color: #34495e;
            font-size: 16px;
            margin-bottom: 10px;
            margin-top: 15px;
        }

        .info-box {
            background: #e7f3ff;
            padding: 12px;
            border-left: 4px solid #2196f3;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .direction-indicator {
            background: #fff9e6;
            padding: 8px;
            border-left: 4px solid #ffc107;
            margin-top: 10px;
            font-size: 13px;
            color: #856404;
            font-weight: bold;
        }

        .equation-block {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .equation-latex {
            margin-bottom: 12px;
            font-size: 16px;
        }

        .equation-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .var-input {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .var-input label {
            font-weight: 600;
            color: #2c3e50;
        }

        .var-input input {
            width: 100px;
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .var-input input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .var-input input.computed {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .var-input .unit {
            color: #7f8c8d;
            font-size: 13px;
        }

        .divider {
            height: 1px;
            background: #ddd;
            margin: 20px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid #28a745;
            margin-top: 20px;
        }

        .given-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .hint {
            font-size: 12px;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 5px;
        }

        .optional-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
        }

        .optional-group h4 {
            color: #495057;
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* Tab System */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-radius: 6px 6px 0 0;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: #e0e0e0;
        }

        .tab-button.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none !important;
        }

        .tab-content.active {
            display: block !important;
        }

        /* Variables Tab */
        .variables-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .variables-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .variables-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }

        .variables-table tr:hover {
            background: #f8f9fa;
        }

        .variables-table input {
            width: 120px;
            padding: 6px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .var-category {
            background: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <!-- PDF Panel -->
    <div id="pdf-panel">
        <iframe src="../../documents/gears/helical_design_spec.pdf" type="application/pdf"></iframe>
    </div>

    <!-- Calculator Panel -->
    <div id="calculator-panel">
        <h1>‚öôÔ∏è Helical Gear Spec Calculator</h1>
        <p class="subtitle">Based on Mott's design specification for helical gears</p>

        <div class="controls">
            <button class="btn btn-primary" onclick="saveSession()">üíæ Save Session</button>
            <button class="btn btn-secondary" onclick="resetAll()">üîÑ Reset All</button>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('procedure')">Procedure</button>
            <button class="tab-button" onclick="showTab('equations')">General Equations</button>
            <button class="tab-button" onclick="showTab('variables')">Variables</button>
        </div>

        <!-- Procedure Tab -->
        <div id="procedure-tab" class="tab-content active">

        <!-- Given Information -->
        <div class="section">
            <h2>Given Information</h2>
            <p style="margin-bottom: 10px;">Enter your known values below:</p>

            <h3>Primary Inputs (always required)</h3>
            <div class="given-inputs">
                <div class="var-input">
                    <label>N =</label>
                    <input type="number" id="N" step="1" oninput="syncAllInstances('N'); markAsUser('N'); calculate()">
                    <span class="unit">(teeth)</span>
                </div>

                <div class="var-input">
                    <label>F =</label>
                    <input type="number" id="F" step="0.0001" oninput="syncAllInstances('F'); markAsUser('F'); calculate()">
                    <span class="unit">in (face width)</span>
                </div>

                <div class="var-input">
                    <label>œà =</label>
                    <input type="number" id="psi" step="0.01" oninput="syncAllInstances('psi'); markAsUser('psi'); calculate()">
                    <span class="unit">deg (helix angle)</span>
                </div>
            </div>

            <div class="optional-group">
                <h4>üìê Diametral Pitch (provide ONE)</h4>
                <div class="info-box">
                    üí° Provide EITHER P<sub>d</sub> (transverse) OR P<sub>nd</sub> (normal). The other will be calculated automatically.
                </div>
                <div class="given-inputs">
                    <div class="var-input">
                        <label>P<sub>d</sub> =</label>
                        <input type="number" id="Pd" step="0.0001" oninput="syncAllInstances('Pd'); markAsUserPd('Pd'); calculate()">
                        <span class="unit">teeth/in (transverse)</span>
                    </div>

                    <div class="var-input">
                        <label>P<sub>nd</sub> =</label>
                        <input type="number" id="Pnd" step="0.0001" oninput="syncAllInstances('Pnd'); markAsUserPd('Pnd'); calculate()">
                        <span class="unit">teeth/in (normal)</span>
                    </div>
                </div>
                <div class="direction-indicator" id="pd-direction">(Provide one to calculate the other)</div>
            </div>

            <div class="optional-group">
                <h4>üìê Pressure Angle (provide ONE)</h4>
                <div class="info-box">
                    üí° Provide EITHER œÜ<sub>t</sub> (transverse) OR œÜ<sub>n</sub> (normal). The other will be calculated automatically.
                </div>
                <div class="given-inputs">
                    <div class="var-input">
                        <label>œÜ<sub>t</sub> =</label>
                        <input type="number" id="phi_t" step="0.01" oninput="syncAllInstances('phi_t'); markAsUserPhi('phi_t'); calculate()">
                        <span class="unit">deg (transverse)</span>
                    </div>

                    <div class="var-input">
                        <label>œÜ<sub>n</sub> =</label>
                        <input type="number" id="phi_n" step="0.01" oninput="syncAllInstances('phi_n'); markAsUserPhi('phi_n'); calculate()">
                        <span class="unit">deg (normal)</span>
                    </div>
                </div>
                <div class="direction-indicator" id="phi-direction">(Provide one to calculate the other)</div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- Calculations -->
        <div class="section">
            <h2>Calculations</h2>
            <p class="hint">Green background = calculated value. You can override any value by editing it.</p>

            <!-- Step 1: Diametral Pitch Conversion -->
            <h3>Step 1: Convert Between Normal and Transverse Diametral Pitch</h3>

            <div class="equation-block">
                <div class="equation-latex">
                    $$P_{nd} = \frac{P_d}{\cos(\psi)}$$ or $$P_d = P_{nd} \cos(\psi)$$
                </div>
                <div class="equation-inputs">
                    <div class="var-input">
                        <label>P<sub>nd</sub> =</label>
                        <input type="number" id="Pnd_eq1" step="0.0001" oninput="syncInput('Pnd', 'Pnd_eq1'); calculate()">
                        <span class="unit">teeth/in</span>
                    </div>
                    <span>=</span>
                    <div class="var-input">
                        <label>P<sub>d</sub> =</label>
                        <input type="number" id="Pd_eq1" step="0.0001" oninput="syncInput('Pd', 'Pd_eq1'); calculate()">
                        <span class="unit">teeth/in</span>
                    </div>
                    <span>/ cos(</span>
                    <div class="var-input">
                        <label>œà =</label>
                        <input type="number" id="psi_eq1" step="0.01" oninput="syncInput('psi', 'psi_eq1'); calculate()">
                        <span class="unit">deg</span>
                    </div>
                    <span>)</span>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Step 2: Circular Pitches -->
            <h3>Step 2: Calculate Circular Pitches</h3>

            <div class="equation-block">
                <div class="equation-latex">
                    $$p_t = \frac{\pi}{P_d}$$
                </div>
                <div class="equation-inputs">
                    <div class="var-input">
                        <label>p<sub>t</sub> =</label>
                        <input type="number" id="pt" step="0.0001" oninput="syncAllInstances('pt'); markAsUser('pt'); calculate()">
                        <span class="unit">in (transverse)</span>
                    </div>
                    <span>= œÄ /</span>
                    <div class="var-input">
                        <label>P<sub>d</sub> =</label>
                        <input type="number" id="Pd_eq2" step="0.0001" oninput="syncInput('Pd', 'Pd_eq2'); calculate()">
                        <span class="unit">teeth/in</span>
                    </div>
                </div>
            </div>

            <div class="equation-block">
                <div class="equation-latex">
                    $$p_n = p_t \cos(\psi)$$
                </div>
                <div class="equation-inputs">
                    <div class="var-input">
                        <label>p<sub>n</sub> =</label>
                        <input type="number" id="pn" step="0.0001" oninput="syncAllInstances('pn'); markAsUser('pn'); calculate()">
                        <span class="unit">in (normal)</span>
                    </div>
                    <span>=</span>
                    <div class="var-input">
                        <label>p<sub>t</sub> =</label>
                        <input type="number" id="pt_eq2" step="0.0001" oninput="syncInput('pt', 'pt_eq2'); calculate()">
                        <span class="unit">in</span>
                    </div>
                    <span>√ó cos(</span>
                    <div class="var-input">
                        <label>œà =</label>
                        <input type="number" id="psi_eq2" step="0.01" oninput="syncInput('psi', 'psi_eq2'); calculate()">
                        <span class="unit">deg</span>
                    </div>
                    <span>)</span>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Step 3: Axial Pitch -->
            <h3>Step 3: Calculate Axial Pitch</h3>

            <div class="equation-block">
                <div class="equation-latex">
                    $$p_x = \frac{p_t}{\tan(\psi)}$$
                </div>
                <div class="equation-inputs">
                    <div class="var-input">
                        <label>p<sub>x</sub> =</label>
                        <input type="number" id="px" step="0.0001" oninput="syncAllInstances('px'); markAsUser('px'); calculate()">
                        <span class="unit">in (axial)</span>
                    </div>
                    <span>=</span>
                    <div class="var-input">
                        <label>p<sub>t</sub> =</label>
                        <input type="number" id="pt_eq3" step="0.0001" oninput="syncInput('pt', 'pt_eq3'); calculate()">
                        <span class="unit">in</span>
                    </div>
                    <span>/ tan(</span>
                    <div class="var-input">
                        <label>œà =</label>
                        <input type="number" id="psi_eq3" step="0.01" oninput="syncInput('psi', 'psi_eq3'); calculate()">
                        <span class="unit">deg</span>
                    </div>
                    <span>)</span>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Step 4: Pitch Diameter -->
            <h3>Step 4: Calculate Pitch Diameter</h3>

            <div class="equation-block">
                <div class="equation-latex">
                    $$D = \frac{N}{P_d}$$
                </div>
                <div class="equation-inputs">
                    <div class="var-input">
                        <label>D =</label>
                        <input type="number" id="D" step="0.0001" oninput="syncAllInstances('D'); markAsUser('D'); calculate()">
                        <span class="unit">in</span>
                    </div>
                    <span>=</span>
                    <div class="var-input">
                        <label>N =</label>
                        <input type="number" id="N_eq4" step="1" oninput="syncInput('N', 'N_eq4'); calculate()">
                        <span class="unit">teeth</span>
                    </div>
                    <span>/</span>
                    <div class="var-input">
                        <label>P<sub>d</sub> =</label>
                        <input type="number" id="Pd_eq4" step="0.0001" oninput="syncInput('Pd', 'Pd_eq4'); calculate()">
                        <span class="unit">teeth/in</span>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Step 5: Pressure Angle Conversion -->
            <h3>Step 5: Convert Between Pressure Angles</h3>

            <div class="equation-block">
                <div class="equation-latex">
                    $$\phi_n = \tan^{-1}(\tan(\phi_t) \cos(\psi))$$ or $$\phi_t = \tan^{-1}\left(\frac{\tan(\phi_n)}{\cos(\psi)}\right)$$
                </div>
                <div class="equation-inputs">
                    <div class="var-input">
                        <label>œÜ<sub>n</sub> =</label>
                        <input type="number" id="phi_n_eq5" step="0.01" oninput="syncInput('phi_n', 'phi_n_eq5'); calculate()">
                        <span class="unit">deg</span>
                    </div>
                    <span>‚Üî</span>
                    <div class="var-input">
                        <label>œÜ<sub>t</sub> =</label>
                        <input type="number" id="phi_t_eq5" step="0.01" oninput="syncInput('phi_t', 'phi_t_eq5'); calculate()">
                        <span class="unit">deg</span>
                    </div>
                    <span>(with œà =</span>
                    <div class="var-input">
                        <input type="number" id="psi_eq5" step="0.01" oninput="syncInput('psi', 'psi_eq5'); calculate()">
                        <span class="unit">deg</span>
                    </div>
                    <span>)</span>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Step 6: Number of Axial Pitches -->
            <h3>Step 6: Calculate Number of Axial Pitches</h3>

            <div class="equation-block">
                <div class="equation-latex">
                    $$N_{ax} = \frac{F}{p_x}$$
                </div>
                <div class="equation-inputs">
                    <div class="var-input">
                        <label>N<sub>ax</sub> =</label>
                        <input type="number" id="Nax" step="0.01" oninput="syncAllInstances('Nax'); markAsUser('Nax'); calculate()">
                        <span class="unit">(dimensionless)</span>
                    </div>
                    <span>=</span>
                    <div class="var-input">
                        <label>F =</label>
                        <input type="number" id="F_eq6" step="0.0001" oninput="syncInput('F', 'F_eq6'); calculate()">
                        <span class="unit">in</span>
                    </div>
                    <span>/</span>
                    <div class="var-input">
                        <label>p<sub>x</sub> =</label>
                        <input type="number" id="px_eq6" step="0.0001" oninput="syncInput('px', 'px_eq6'); calculate()">
                        <span class="unit">in</span>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="success">‚úÖ You're done!</div>
        </div>

        </div> <!-- End Procedure Tab -->

        <!-- General Equations Tab -->
        <div id="equations-tab" class="tab-content">
            <div class="section">
                <h2>Helical Gear General Equations</h2>

                <h3>Pitch Relationships</h3>

                <div class="equation-block">
                    <div class="equation-latex">
                        $$P_{nd} = \frac{P_d}{\cos(\psi)}$$
                    </div>
                    <div class="equation-inputs">
                        <div class="var-input">
                            <label>P<sub>nd</sub> =</label>
                            <input type="number" id="Pnd_gen" step="0.0001" oninput="syncAllInstances('Pnd_gen'); markAsUserPd('Pnd_gen'); calculate()">
                            <span class="unit">teeth/in</span>
                        </div>
                        <span>= </span>
                        <div class="var-input">
                            <label>P<sub>d</sub> =</label>
                            <input type="number" id="Pd_gen" step="0.0001" oninput="syncAllInstances('Pd_gen'); markAsUserPd('Pd_gen'); calculate()">
                            <span class="unit">teeth/in</span>
                        </div>
                        <span>/ cos(</span>
                        <div class="var-input">
                            <label>œà =</label>
                            <input type="number" id="psi_gen" step="0.01" oninput="syncAllInstances('psi_gen'); markAsUser('psi_gen'); calculate()">
                            <span class="unit">deg</span>
                        </div>
                        <span>)</span>
                    </div>
                </div>

                <div class="equation-block">
                    <div class="equation-latex">
                        $$p_t = \frac{\pi}{P_d}$$
                    </div>
                    <div class="equation-inputs">
                        <div class="var-input">
                            <label>p<sub>t</sub> =</label>
                            <input type="number" id="pt_gen" step="0.0001" oninput="syncAllInstances('pt_gen'); markAsUser('pt_gen'); calculate()">
                            <span class="unit">in</span>
                        </div>
                        <span>= œÄ / </span>
                        <div class="var-input">
                            <label>P<sub>d</sub> =</label>
                            <input type="number" id="Pd_gen2" step="0.0001" oninput="syncAllInstances('Pd_gen2'); markAsUserPd('Pd_gen2'); calculate()">
                            <span class="unit">teeth/in</span>
                        </div>
                    </div>
                </div>

                <div class="equation-block">
                    <div class="equation-latex">
                        $$p_n = p_t \cos(\psi)$$
                    </div>
                    <div class="equation-inputs">
                        <div class="var-input">
                            <label>p<sub>n</sub> =</label>
                            <input type="number" id="pn_gen" step="0.0001" oninput="syncAllInstances('pn_gen'); markAsUser('pn_gen'); calculate()">
                            <span class="unit">in</span>
                        </div>
                        <span>= </span>
                        <div class="var-input">
                            <label>p<sub>t</sub> =</label>
                            <input type="number" id="pt_gen2" step="0.0001" oninput="syncAllInstances('pt_gen2'); markAsUser('pt_gen2'); calculate()">
                            <span class="unit">in</span>
                        </div>
                        <span>√ó cos(</span>
                        <div class="var-input">
                            <label>œà =</label>
                            <input type="number" id="psi_gen2" step="0.01" oninput="syncAllInstances('psi_gen2'); markAsUser('psi_gen2'); calculate()">
                            <span class="unit">deg</span>
                        </div>
                        <span>)</span>
                    </div>
                </div>

                <div class="equation-block">
                    <div class="equation-latex">
                        $$p_x = \frac{p_t}{\tan(\psi)}$$
                    </div>
                    <div class="equation-inputs">
                        <div class="var-input">
                            <label>p<sub>x</sub> =</label>
                            <input type="number" id="px_gen" step="0.0001" oninput="syncAllInstances('px_gen'); markAsUser('px_gen'); calculate()">
                            <span class="unit">in</span>
                        </div>
                        <span>= </span>
                        <div class="var-input">
                            <label>p<sub>t</sub> =</label>
                            <input type="number" id="pt_gen3" step="0.0001" oninput="syncAllInstances('pt_gen3'); markAsUser('pt_gen3'); calculate()">
                            <span class="unit">in</span>
                        </div>
                        <span>/ tan(</span>
                        <div class="var-input">
                            <label>œà =</label>
                            <input type="number" id="psi_gen3" step="0.01" oninput="syncAllInstances('psi_gen3'); markAsUser('psi_gen3'); calculate()">
                            <span class="unit">deg</span>
                        </div>
                        <span>)</span>
                    </div>
                </div>

                <h3>Pressure Angle Relationships</h3>

                <div class="equation-block">
                    <div class="equation-latex">
                        $$\phi_n = \tan^{-1}(\tan(\phi_t) \cos(\psi))$$
                    </div>
                    <div class="equation-inputs">
                        <div class="var-input">
                            <label>œÜ<sub>n</sub> =</label>
                            <input type="number" id="phi_n_gen" step="0.01" oninput="syncAllInstances('phi_n_gen'); markAsUserPhi('phi_n_gen'); calculate()">
                            <span class="unit">deg</span>
                        </div>
                        <span>= arctan(tan(</span>
                        <div class="var-input">
                            <label>œÜ<sub>t</sub> =</label>
                            <input type="number" id="phi_t_gen" step="0.01" oninput="syncAllInstances('phi_t_gen'); markAsUserPhi('phi_t_gen'); calculate()">
                            <span class="unit">deg</span>
                        </div>
                        <span>) √ó cos(</span>
                        <div class="var-input">
                            <label>œà =</label>
                            <input type="number" id="psi_gen4" step="0.01" oninput="syncAllInstances('psi_gen4'); markAsUser('psi_gen4'); calculate()">
                            <span class="unit">deg</span>
                        </div>
                        <span>))</span>
                    </div>
                </div>

                <h3>Diameter and Geometry</h3>

                <div class="equation-block">
                    <div class="equation-latex">
                        $$D = \frac{N}{P_d}$$
                    </div>
                    <div class="equation-inputs">
                        <div class="var-input">
                            <label>D =</label>
                            <input type="number" id="D_gen" step="0.0001" oninput="syncAllInstances('D_gen'); markAsUser('D_gen'); calculate()">
                            <span class="unit">in</span>
                        </div>
                        <span>= </span>
                        <div class="var-input">
                            <label>N =</label>
                            <input type="number" id="N_gen" step="1" oninput="syncAllInstances('N_gen'); markAsUser('N_gen'); calculate()">
                            <span class="unit">teeth</span>
                        </div>
                        <span>/ </span>
                        <div class="var-input">
                            <label>P<sub>d</sub> =</label>
                            <input type="number" id="Pd_gen3" step="0.0001" oninput="syncAllInstances('Pd_gen3'); markAsUserPd('Pd_gen3'); calculate()">
                            <span class="unit">teeth/in</span>
                        </div>
                    </div>
                </div>

                <div class="equation-block">
                    <div class="equation-latex">
                        $$N_{ax} = \frac{F}{p_x}$$
                    </div>
                    <div class="equation-inputs">
                        <div class="var-input">
                            <label>N<sub>ax</sub> =</label>
                            <input type="number" id="Nax_gen" step="0.01" oninput="syncAllInstances('Nax_gen'); markAsUser('Nax_gen'); calculate()">
                            <span class="unit"></span>
                        </div>
                        <span>= </span>
                        <div class="var-input">
                            <label>F =</label>
                            <input type="number" id="F_gen" step="0.0001" oninput="syncAllInstances('F_gen'); markAsUser('F_gen'); calculate()">
                            <span class="unit">in</span>
                        </div>
                        <span>/ </span>
                        <div class="var-input">
                            <label>p<sub>x</sub> =</label>
                            <input type="number" id="px_gen2" step="0.0001" oninput="syncAllInstances('px_gen2'); markAsUser('px_gen2'); calculate()">
                            <span class="unit">in</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Variables Tab -->
        <div id="variables-tab" class="tab-content">
            <h2>All Variables</h2>
            <table class="variables-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Description</th>
                        <th>Value</th>
                        <th>Unit</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="var-category"><td colspan="4">Basic Parameters</td></tr>
                    <tr>
                        <td>N</td>
                        <td>Number of Teeth</td>
                        <td><input type="number" id="var_N" step="1" oninput="syncAllInstances('var_N'); markAsUser('var_N'); calculate()"></td>
                        <td>teeth</td>
                    </tr>
                    <tr>
                        <td>F</td>
                        <td>Face Width</td>
                        <td><input type="number" id="var_F" step="0.0001" oninput="syncAllInstances('var_F'); markAsUser('var_F'); calculate()"></td>
                        <td>in</td>
                    </tr>
                    <tr>
                        <td>œà</td>
                        <td>Helix Angle</td>
                        <td><input type="number" id="var_psi" step="0.01" oninput="syncAllInstances('var_psi'); markAsUser('var_psi'); calculate()"></td>
                        <td>deg</td>
                    </tr>

                    <tr class="var-category"><td colspan="4">Diametral Pitch</td></tr>
                    <tr>
                        <td>P<sub>d</sub></td>
                        <td>Diametral Pitch (Transverse)</td>
                        <td><input type="number" id="var_Pd" step="0.0001" oninput="syncAllInstances('var_Pd'); markAsUserPd('var_Pd'); calculate()"></td>
                        <td>teeth/in</td>
                    </tr>
                    <tr>
                        <td>P<sub>nd</sub></td>
                        <td>Diametral Pitch (Normal)</td>
                        <td><input type="number" id="var_Pnd" step="0.0001" oninput="syncAllInstances('var_Pnd'); markAsUserPd('var_Pnd'); calculate()"></td>
                        <td>teeth/in</td>
                    </tr>

                    <tr class="var-category"><td colspan="4">Pressure Angles</td></tr>
                    <tr>
                        <td>œÜ<sub>t</sub></td>
                        <td>Pressure Angle (Transverse)</td>
                        <td><input type="number" id="var_phi_t" step="0.01" oninput="syncAllInstances('var_phi_t'); markAsUserPhi('var_phi_t'); calculate()"></td>
                        <td>deg</td>
                    </tr>
                    <tr>
                        <td>œÜ<sub>n</sub></td>
                        <td>Pressure Angle (Normal)</td>
                        <td><input type="number" id="var_phi_n" step="0.01" oninput="syncAllInstances('var_phi_n'); markAsUserPhi('var_phi_n'); calculate()"></td>
                        <td>deg</td>
                    </tr>

                    <tr class="var-category"><td colspan="4">Circular Pitches</td></tr>
                    <tr>
                        <td>p<sub>t</sub></td>
                        <td>Circular Pitch (Transverse)</td>
                        <td><input type="number" id="var_pt" step="0.0001" oninput="syncAllInstances('var_pt'); markAsUser('var_pt'); calculate()"></td>
                        <td>in</td>
                    </tr>
                    <tr>
                        <td>p<sub>n</sub></td>
                        <td>Circular Pitch (Normal)</td>
                        <td><input type="number" id="var_pn" step="0.0001" oninput="syncAllInstances('var_pn'); markAsUser('var_pn'); calculate()"></td>
                        <td>in</td>
                    </tr>
                    <tr>
                        <td>p<sub>x</sub></td>
                        <td>Axial Pitch</td>
                        <td><input type="number" id="var_px" step="0.0001" oninput="syncAllInstances('var_px'); markAsUser('var_px'); calculate()"></td>
                        <td>in</td>
                    </tr>

                    <tr class="var-category"><td colspan="4">Dimensions</td></tr>
                    <tr>
                        <td>D</td>
                        <td>Pitch Diameter</td>
                        <td><input type="number" id="var_D" step="0.0001" oninput="syncAllInstances('var_D'); markAsUser('var_D'); calculate()"></td>
                        <td>in</td>
                    </tr>
                    <tr>
                        <td>N<sub>ax</sub></td>
                        <td>Number of Axial Pitches</td>
                        <td><input type="number" id="var_Nax" step="0.01" oninput="syncAllInstances('var_Nax'); markAsUser('var_Nax'); calculate()"></td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <script>
        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const activeTab = document.getElementById(tabName + '-tab');
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // Activate button
            event.currentTarget.classList.add('active');

            // Re-render MathJax for the active tab
            if (typeof MathJax !== 'undefined') {
                if (activeTab) {
                    MathJax.typesetPromise([activeTab]).catch((err) => console.log(err));
                }
            }
        }

        // Variable Instance Mapping for Bidirectional Sync
        const varInstanceMap = {
            'N': ['N', 'var_N', 'N_eq4', 'N_gen'],
            'F': ['F', 'var_F', 'F_eq6', 'F_gen'],
            'psi': ['psi', 'var_psi', 'psi_eq1', 'psi_eq2', 'psi_eq3', 'psi_eq5', 'psi_gen', 'psi_gen2', 'psi_gen3', 'psi_gen4'],
            'Pd': ['Pd', 'var_Pd', 'Pd_eq1', 'Pd_eq2', 'Pd_eq4', 'Pd_gen', 'Pd_gen2', 'Pd_gen3'],
            'Pnd': ['Pnd', 'var_Pnd', 'Pnd_eq1', 'Pnd_gen'],
            'phi_t': ['phi_t', 'var_phi_t', 'phi_t_eq5', 'phi_t_gen'],
            'phi_n': ['phi_n', 'var_phi_n', 'phi_n_eq5', 'phi_n_gen'],
            'pt': ['pt', 'var_pt', 'pt_eq2', 'pt_eq3', 'pt_gen', 'pt_gen2', 'pt_gen3'],
            'pn': ['pn', 'var_pn', 'pn_gen'],
            'px': ['px', 'var_px', 'px_eq6', 'px_gen', 'px_gen2'],
            'D': ['D', 'var_D', 'D_gen'],
            'Nax': ['Nax', 'var_Nax', 'Nax_gen']
        };

        function getBaseVarName(id) {
            if (id.startsWith('var_')) {
                return id.substring(4);
            }
            let underscoreIndex = id.indexOf('_eq');
            if (underscoreIndex !== -1) {
                return id.substring(0, underscoreIndex);
            }
            underscoreIndex = id.indexOf('_gen');
            if (underscoreIndex !== -1) {
                return id.substring(0, underscoreIndex);
            }
            return id;
        }

        function syncAllInstances(changedId) {
            const baseVar = getBaseVarName(changedId);
            const instances = varInstanceMap[baseVar];
            if (!instances) return;

            const changedInput = document.getElementById(changedId);
            if (!changedInput) return;

            const newValue = changedInput.value;

            instances.forEach(instanceId => {
                if (instanceId !== changedId) {
                    const input = document.getElementById(instanceId);
                    if (input) {
                        input.value = newValue;
                    }
                }
            });
        }

        // Track which values are user-entered vs computed
        let userValues = new Set(['N', 'F', 'psi']);

        // Track which secondary input user provided
        let userProvidedPd = null;  // true = Pd, false = Pnd, null = neither
        let userProvidedPhi = null; // true = phi_t, false = phi_n, null = neither

        // Mark a field as user-entered
        function markAsUser(fieldId) {
            userValues.add(fieldId);
        }

        // Mark Pd/Pnd as user-entered and track direction
        function markAsUserPd(fieldId) {
            userValues.add(fieldId);
            if (fieldId === 'Pd') {
                userProvidedPd = true;
            } else if (fieldId === 'Pnd') {
                userProvidedPd = false;
            }
        }

        // Mark phi_t/phi_n as user-entered and track direction
        function markAsUserPhi(fieldId) {
            userValues.add(fieldId);
            if (fieldId === 'phi_t') {
                userProvidedPhi = true;
            } else if (fieldId === 'phi_n') {
                userProvidedPhi = false;
            }
        }

        // Sync duplicate fields
        function syncInput(mainId, sourceId) {
            const sourceElement = document.getElementById(sourceId);
            const mainElement = document.getElementById(mainId);
            const value = sourceElement.value;
            mainElement.value = value;

            // Sync all instances including Variables tab
            syncAllInstances(sourceId);

            // Only mark as user input if source was user-entered
            if (userValues.has(sourceId) || !sourceElement.classList.contains('computed')) {
                markAsUser(mainId);
            }
        }

        // Get value with fallback
        function getValue(id) {
            const element = document.getElementById(id);
            if (!element) return null;
            const val = parseFloat(element.value);
            return isNaN(val) ? null : val;
        }

        // Set value and mark as computed
        function setValue(id, value) {
            if (value !== null && !userValues.has(id)) {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value.toFixed(4);
                    element.classList.add('computed');
                    // Sync to all instances including Variables tab and General Equations tab
                    syncAllInstances(id);
                }
            }
        }

        // Sync all duplicate fields
        function syncAllFields() {
            const mainVars = ['N', 'F', 'psi', 'Pd', 'Pnd', 'phi_t', 'phi_n', 'pt', 'pn', 'px', 'D', 'Nax'];

            mainVars.forEach(varId => {
                const mainValue = getValue(varId);
                const mainElement = document.getElementById(varId);
                const isComputed = mainElement && mainElement.classList.contains('computed');

                if (mainValue !== null) {
                    document.querySelectorAll(`input[id^="${varId}_eq"]`).forEach(input => {
                        if (getValue(input.id) !== mainValue) {
                            input.value = mainValue.toFixed(4);
                        }
                        // Apply computed class to synced fields if main is computed
                        if (isComputed && !userValues.has(input.id)) {
                            input.classList.add('computed');
                        }
                    });
                }
            });
        }

        function updateDirectionIndicators() {
            const pdIndicator = document.getElementById('pd-direction');
            const phiIndicator = document.getElementById('phi-direction');

            if (userProvidedPd === true) {
                pdIndicator.textContent = '‚Üí Calculating Pnd from Pd';
                pdIndicator.style.background = '#d4edda';
                pdIndicator.style.borderColor = '#28a745';
                pdIndicator.style.color = '#155724';
            } else if (userProvidedPd === false) {
                pdIndicator.textContent = '‚Üí Calculating Pd from Pnd';
                pdIndicator.style.background = '#d4edda';
                pdIndicator.style.borderColor = '#28a745';
                pdIndicator.style.color = '#155724';
            } else {
                pdIndicator.textContent = '(Provide one to calculate the other)';
                pdIndicator.style.background = '#fff9e6';
                pdIndicator.style.borderColor = '#ffc107';
                pdIndicator.style.color = '#856404';
            }

            if (userProvidedPhi === true) {
                phiIndicator.textContent = '‚Üí Calculating œÜn from œÜt';
                phiIndicator.style.background = '#d4edda';
                phiIndicator.style.borderColor = '#28a745';
                phiIndicator.style.color = '#155724';
            } else if (userProvidedPhi === false) {
                phiIndicator.textContent = '‚Üí Calculating œÜt from œÜn';
                phiIndicator.style.background = '#d4edda';
                phiIndicator.style.borderColor = '#28a745';
                phiIndicator.style.color = '#155724';
            } else {
                phiIndicator.textContent = '(Provide one to calculate the other)';
                phiIndicator.style.background = '#fff9e6';
                phiIndicator.style.borderColor = '#ffc107';
                phiIndicator.style.color = '#856404';
            }
        }

        function calculate() {
            // Get primary inputs
            const N = getValue('N');
            const F = getValue('F');
            const psi = getValue('psi');

            if (!psi) {
                updateDirectionIndicators();
                return;
            }

            const psiRad = psi * Math.PI / 180;

            // Step 1: Bidirectional Pd/Pnd conversion
            const Pd = getValue('Pd');
            const Pnd = getValue('Pnd');

            if (Pd && Pd > 0 && userProvidedPd !== false) {
                // User provided Pd, calculate Pnd
                setValue('Pnd', Pd / Math.cos(psiRad));
            } else if (Pnd && Pnd > 0 && userProvidedPd !== true) {
                // User provided Pnd, calculate Pd
                setValue('Pd', Pnd * Math.cos(psiRad));
            }

            // Step 5: Bidirectional phi_t/phi_n conversion
            const phi_t = getValue('phi_t');
            const phi_n = getValue('phi_n');

            if (phi_t && phi_t > 0 && userProvidedPhi !== false) {
                // User provided phi_t, calculate phi_n
                const phi_t_rad = phi_t * Math.PI / 180;
                const phi_n_rad = Math.atan(Math.tan(phi_t_rad) * Math.cos(psiRad));
                const phi_n_deg = phi_n_rad * 180 / Math.PI;
                setValue('phi_n', phi_n_deg);
            } else if (phi_n && phi_n > 0 && userProvidedPhi !== true) {
                // User provided phi_n, calculate phi_t
                const phi_n_rad = phi_n * Math.PI / 180;
                const phi_t_rad = Math.atan(Math.tan(phi_n_rad) / Math.cos(psiRad));
                const phi_t_deg = phi_t_rad * 180 / Math.PI;
                setValue('phi_t', phi_t_deg);
            }

            // Now get the calculated Pd (could be from user or calculated)
            const Pd_final = getValue('Pd');

            if (Pd_final && Pd_final > 0) {
                // Step 2: Circular pitches
                setValue('pt', Math.PI / Pd_final);

                const pt = getValue('pt');
                if (pt !== null) {
                    setValue('pn', pt * Math.cos(psiRad));
                }

                // Step 3: Axial pitch
                if (pt !== null) {
                    setValue('px', pt / Math.tan(psiRad));
                }

                // Step 4: Pitch diameter
                if (N && N > 0) {
                    setValue('D', N / Pd_final);
                }

                // Step 6: Number of axial pitches
                const px = getValue('px');
                if (F !== null && px !== null && px > 0) {
                    setValue('Nax', F / px);
                }
            }

            // Sync duplicate fields
            syncAllFields();

            // Update direction indicators
            updateDirectionIndicators();
        }

        function saveSession() {
            const data = {};
            document.querySelectorAll('input[type="number"]').forEach(input => {
                if (input.value) {
                    data[input.id] = input.value;
                }
            });
            data._userValues = Array.from(userValues);
            data._userProvidedPd = userProvidedPd;
            data._userProvidedPhi = userProvidedPhi;
            localStorage.setItem('helicalGearSession', JSON.stringify(data));
            alert('Session saved!');
        }

        function loadSession() {
            const saved = localStorage.getItem('helicalGearSession');
            if (saved) {
                const data = JSON.parse(saved);
                for (let key in data) {
                    if (key === '_userValues') {
                        userValues = new Set(data[key]);
                    } else if (key === '_userProvidedPd') {
                        userProvidedPd = data[key];
                    } else if (key === '_userProvidedPhi') {
                        userProvidedPhi = data[key];
                    } else {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = data[key];
                        }
                    }
                }
            }
        }

        function resetAll() {
            if (confirm('Reset all values?')) {
                document.querySelectorAll('input').forEach(input => {
                    input.value = '';
                    input.classList.remove('computed');
                });
                userValues = new Set(['N', 'F', 'psi']);
                userProvidedPd = null;
                userProvidedPhi = null;
                localStorage.removeItem('helicalGearSession');
                updateDirectionIndicators();
                calculate();
            }
        }

        // Load on startup
        window.addEventListener('load', function() {
            loadSession();
            calculate();
            updateDirectionIndicators();
        });
    </script>
</body>
</html>
